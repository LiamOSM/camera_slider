<!DOCTYPE html>
<meta charset="utf-8" />
<title>Camera Slider</title>

<script language="javascript" type="text/javascript">

// default IP for ESP32 in AP mode
var url = "ws://192.168.4.1:1024/";


var slider;
var sliderValue;
var jogLeftBtn;
var jogRightBtn;
var counter;

var loopNoneRadio;
var loopOnceRadio;
var loopForeverRadio;

var startField;
var currentToStartBtn;
var endField;
var currentToEndBtn;
var swapBtn;

var runBtn;
var pauseBtn;
var resetBtn;

var speedRadio;
var durationRadio;
var speedField;

var calibrateBtn;

var state;
var stateSpan;

// This is called when the page finishes loading
function init() {

  // Assign page elements to variables
  slider = document.getElementById("slider");
  sliderValue = document.getElementById("sliderValue");
  sliderValue.innerHTML = 69;

  stateSpan = document.getElementById("stateSpan");

  jogLeftBtn = document.getElementById("jogLeftBtn");
  jogRightBtn = document.getElementById("jogRightBtn");

  loopNoneRadio = document.getElementById("loopNoneRadio");
  loopOnceRadio = document.getElementById("loopOnceRadio");
  loopForeverRadio = document.getElementById("loopForeverRadio");

  startField = document.getElementById("startField");
  currentToStartBtn = document.getElementById("currentToStartBtn");
  endField = document.getElementById("endField");
  currentToEndBtn = document.getElementById("currentToEndBtn");
  swapBtn = document.getElementById("swapBtn");

  runBtn = document.getElementById("runBtn");
  pauseBtn = document.getElementById("pauseBtn");
  resetBtn = document.getElementById("resetBtn");

  speedRadio = document.getElementById("speedRadio");
  durationRadio = document.getElementById("durationRadio");
  speedField = document.getElementById("speedField");

  calibrateBtn = document.getElementById("calibrateBtn");

  setState(0); // idle on startup

  // enable run & reset, disable pause
  runBtn.disabled = false;
  pauseBtn.disabled = true;
  resetBtn.disabled = false;

  // remove above three lines and uncomment below three lines
  // runBtn.disabled = true;
  // pauseBtn.disabled = true;
  // resetBtn.disabled = true;

  // Connect to WebSocket server
  wsConnect(url);
}

// Call this to connect to the WebSocket server
function wsConnect(url) {

  // Connect to WebSocket server
  websocket = new WebSocket(url);

  // Assign callbacks
  websocket.onopen = function(evt) { onOpen(evt) };
  websocket.onclose = function(evt) { onClose(evt) };
  websocket.onmessage = function(evt) { onMessage(evt) };
  websocket.onerror = function(evt) { onError(evt) };
}

// Called when a WebSocket connection is established with the server
function onOpen(evt) {
  // enable buttons
  // enable run & reset, disable pause
  runBtn.disabled = false;
  pauseBtn.disabled = true;
  resetBtn.disabled = false;
}

// Called when the WebSocket connection is closed
function onClose(evt) {

  // Disable buttons
  runBtn.disabled = true;
  pauseBtn.disabled = true;
  resetBtn.disabled = true;

  // Try to reconnect after a few seconds
  setTimeout(function() { wsConnect(url) }, 2000);
}

// Called when a message is received from the server
function onMessage(evt) {
  // the message is called "evt.data"
}

// Called when a WebSocket error occurs
function onError(evt) {
  // sucks to suck!
}

// Sends a message to the server (and prints it to the console)
function doSend(message) {
  websocket.send(message);
}

// Call the init function as soon as the page loads
window.addEventListener("load", init, false);

function sliderChanged() {
  sliderValue.innerHTML = slider.value;
}

function jogLeftStart() {
  // do it once right away, in case the press lasts less than 250ms
  slider.value--;
  sliderChanged();
  // now start the interval timing:
  counter = setInterval(function() {
    slider.value--;
    sliderChanged();
  }, 250);
}

function jogLeftEnd() {
  clearInterval(counter)
}

function jogRightStart() {
  // do it once right away, in case the press lasts less than 250ms
  slider.value++;
  sliderChanged();
  // now start the interval timing:
  counter = setInterval(function() {
    slider.value++;
    sliderChanged();
  }, 250);
}

function jogRightEnd() {
  clearInterval(counter)
}

function run(){
  setState(1); // running state is 1
}

function pause(){
  setState(2); // paused state is 2
}

function reset(){
  setState(0); // idle state is 0
}

function setState(newState){
  // States:
  // 0 = idle
  // 1 = running
  // 2 = paused
  state = newState;
  switch(state) {
    case 0:
      stateSpan.innerHTML = "Idle";
      // enable run & reset, disable pause
      runBtn.disabled = false;
      pauseBtn.disabled = true;
      resetBtn.disabled = false;
      break;
    case 1:
      stateSpan.innerHTML = "Running";
      // enable run & reset, disable pause
      runBtn.disabled = true;
      pauseBtn.disabled = false;
      resetBtn.disabled = true;
      break;
    case 2:
      stateSpan.innerHTML = "Paused";
      // enable run & reset, disable pause
      runBtn.disabled = false;
      pauseBtn.disabled = true;
      resetBtn.disabled = false;
      break;
    default:
      stateSpan.innerHTML = "Error";
  }
}

</script>


<!-- The actual webpage HTML is below -->

<style>
.positionSlider {
  width: 400px;
}

.positionalStuff {
  position: absolute;
  left: 50%;
  transform: translate(-50%, 10px);
}

.main {
  position: absolute;
  left: 50%;
  transform: translate(-50%, 20px);
}
</style>

<center><h2>Position: <span id="sliderValue"></span> mm</h2></center>
<center><strong>Status: </strong><span id="stateSpan"></span></center>
<center>
  <button id="runBtn" onclick="run()">Run</button>
  <button id="pauseBtn" onclick="pause()">Pause</button>
  <button id="resetBtn" onclick="reset()">Reset</button>
</center>

<body>

  <div class="positionalStuff">
    <button id="jogLeftBtn" onmousedown="jogLeftStart()" onmouseup="jogLeftEnd()">&#8592</button>
    <input id="slider" type="range" min="0" max="1000" step="1" oninput="sliderChanged();" value="69" class="positionSlider">
    <button id="jogRightBtn" onmousedown="jogRightStart()" onmouseup="jogRightEnd()">&#8594</button>
  </div>

  <div class="main">
    <p>
      <strong>Loop Mode:</strong><br>
      <input type="radio" id="loopNoneRadio" name="loopGroup" value="loop1" checked>
      <label for="loopNoneRadio">No Loop</label><br>
      <input type="radio" id="loopOnceRadio" name="loopGroup" value="loop2">
      <label for="loopOnceRadio">Loop Once</label><br>
      <input type="radio" id="loopForeverRadio" name="loopGroup" value="loop3">
      <label for="loopForeverRadio">Loop Forever</label>
    </p>
  </div>

</body>
